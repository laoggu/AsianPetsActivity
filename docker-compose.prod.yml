services:
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"  # 如果需要HTTPS
    volumes:
      - ./nginx/conf/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/logs:/var/log/nginx
      - ./nginx/ssl:/opt/ssl:ro
    depends_on:
      - app
    networks:
      - asianpets-network
    restart: unless-stopped

  app:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8081:8081"  # 映射端口便于调试
    env_file:
      - .env
    # extra_hosts:
    #   - "host.docker.internal:host-gateway"
    # network_mode: "host"  # 如果host模式有问题，注释掉这行
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      # 连接服务器本地数据库
      - SPRING_DATASOURCE_URL=jdbc:mysql://10.0.0.10:3306/asian_pets_system
      - SPRING_DATASOURCE_USERNAME=AsainPetsAdmin
      - SPRING_DATASOURCE_PASSWORD=Yk731207
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=com.mysql.cj.jdbc.Driver
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SERVER_PORT=8081
      - JWT_SECRET=${JWT_SECRET}
      - LOGGING_LEVEL_ROOT=INFO
    networks:
      - asianpets-network
    restart: unless-stopped
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  asianpets-network:
    driver: bridge
